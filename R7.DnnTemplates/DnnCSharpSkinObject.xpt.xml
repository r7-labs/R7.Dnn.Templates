<?xml version="1.0"?>
<Template originator="Roman M. Yagodin" created="2014/05/15">
	<!-- Template Header -->
	<TemplateConfiguration>
		<_Name>C# compiled skin object</_Name>
		<_Category>C#/DNN Platform</_Category>
		<Icon>md-project-web|res:project-dnn-overlay-32.png</Icon>
		<LanguageName>C#</LanguageName>
        <ProjectType>AspNetApp</ProjectType>
		<_Description>Creates a new DNN Platform C# compiled skin object project.

NOTE: Ensure that 'Create directory for solution' flag is checked.</_Description>
	</TemplateConfiguration>
	<!-- Actions -->
	<Actions>
		<Open filename="SETUP.md" />
	</Actions>
	<!-- Template Content -->
	<Combine name="${ProjectName}" directory=".">
		<Options>
			<StartupProject>"${ProjectName}</StartupProject>
		</Options>
		<Project name="${ProjectName}" directory="." type="AspNetApp">
			<!-- Causes errors in ASP.NET code completition! 
				<Options Target="Library" TargetFrameworkVersion="4.0" /> 
			-->
			<References>
				<Reference type="Package" refto="System, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089" />
				<Reference type="Package" refto="System.Core, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089" />
				<Reference type="Package" refto="System.Xml, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089" />
				<Reference type="Package" refto="System.Data, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089" />
				<Reference type="Package" refto="System.Web, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a" />
				<Reference type="Package" refto="System.Web.Services, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a" />
				<Reference type="Package" refto="System.Web.Extensions, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35" />
				<Reference type="Package" refto="System.Xml.Linq, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089" />
			</References>
            <Packages>
                <Package id="DotNetNuke.R7" version="0.3.1" />
            </Packages>
			<!-- Other refrences (for future use):
	<Reference type="Package" refto="System, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089" />
	<Reference type="Package" refto="System.Web.Routing, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35" SpecificVersion="false" />
	<Reference type="Package" refto="System.Web.Abstractions, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35" SpecificVersion="false" />
	<Reference type="Package" refto="System.Web.Mvc, Version=3.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35" SpecificVersion="false" />
	<Reference type="Package" refto="System.Web.WebPages, Version=1.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35" />
	<Reference type="Package" refto="System.Web.Helpers, Version=1.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35" />
	<Reference type="Package" refto="System.Web.DynamicData, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35" />
	<Reference type="Package" refto="System.ComponentModel.DataAnnotations, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35" SpecificVersion="false" />
	<Reference type="Package" refto="Microsoft.CSharp, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a" />
	-->
			<Files>
                <Directory name="SqlDataProvider">
				<File name="00.01.00.SqlDataProvider"><![CDATA[-- NOTE: To manually execute this script you must 
-- replace {databaseOwner} and {objectQualifier} with real values. 
-- Defaults is "dbo." for database owner and "" for object qualifier 

-- Create tables

IF NOT EXISTS (select * from sys.objects where object_id = object_id (N'{databaseOwner}[{objectQualifier}${ProjectName}_${ProjectName}s]') and type in (N'U'))
    BEGIN
        CREATE TABLE {databaseOwner}[{objectQualifier}${ProjectName}_${ProjectName}s]
        (
            [${ProjectName}ID] int NOT NULL IDENTITY (1, 1),
            [TabID] int NOT NULL,
            [Content] nvarchar(max) NOT NULL,
            [CreatedByUser] int NOT NULL,
            [CreatedOnDate] datetime NOT NULL DEFAULT (GETDATE ())
            CONSTRAINT [PK_{objectQualifier}${ProjectName}_${ProjectName}s] PRIMARY KEY CLUSTERED (${ProjectName}ID)
            CONSTRAINT [FK_{objectQualifier}${ProjectName}_${ProjectName}s_{objectQualifier}Tabs] FOREIGN KEY (TabID)
                REFERENCES {databaseOwner}[{objectQualifier}Tabs] (TabID) ON DELETE CASCADE
        )
            
        CREATE NONCLUSTERED INDEX [IX_{objectQualifier}${ProjectName}_${ProjectName}s_TabID] 
            ON {databaseOwner}[{objectQualifier}${ProjectName}_${ProjectName}s] ([TabID])
    END
GO

-- Drop existing stored procedures

---- Just example:
-- IF EXISTS (select * from sys.objects where object_id = object_id (N'{databaseOwner}[{objectQualifier}${ProjectName}_Get${ProjectName}s]') and type in (N'P'))
--  DROP PROCEDURE {databaseOwner}{objectQualifier}${ProjectName}_Get${ProjectName}s
-- GO

-- Create stored procedures

---- Just example:
-- CREATE PROCEDURE {databaseOwner}{objectQualifier}${ProjectName}_Get${ProjectName}s
--  @ModuleId int
-- AS 
-- SELECT [${ProjectName}ID]
--  [ModuleID],
--  [Content],
--  [CreatedByUser],
--  [CreatedOnDate],
--  'CreatedByUserName' = {objectQualifier}Users.FirstName + ' ' + {objectQualifier}Users.LastName
-- FROM {objectQualifier}${ProjectName}_${ProjectName}s
-- INNER JOIN {objectQualifier}Users on {objectQualifier}${ProjectName}_${ProjectName}s.CreatedByUser = {objectQualifier}Users.UserId
-- WHERE [ModuleID] = @ModuleId
-- GO
]]></File>
				<File name="Uninstall.SqlDataProvider"><![CDATA[-- NOTE: To manually execute this script you must 
-- replace {databaseOwner} and {objectQualifier} with real values. 
-- Defaults is "dbo." for database owner and "" for object qualifier 

-- Drop tables

ALTER TABLE {databaseOwner}[{objectQualifier}${ProjectName}_${ProjectName}s] 
	DROP CONSTRAINT [FK_{objectQualifier}${ProjectName}_${ProjectName}s_{objectQualifier}Tabs]
GO

DROP INDEX {databaseOwner}[{objectQualifier}${ProjectName}_${ProjectName}s].[IX_{objectQualifier}${ProjectName}_${ProjectName}s_TabID]
GO

DROP TABLE {databaseOwner}[{objectQualifier}${ProjectName}_${ProjectName}s]
GO
]]></File>
    </Directory>
				<Directory name="App_LocalResources">
					<File name="${ProjectName}.ascx.resx"><![CDATA[<?xml version="1.0" encoding="utf-8"?>
<root>
  <data xml:space="preserve" name="Template.Text">
    <value>&lt;div class="[CSSCLASS]"&gt;&lt;h3&gt;[CREATEDBYUSER]: [CREATEDONDATE]&lt;/h3&gt;&lt;p&gt;[CONTENT]&lt;/p&gt;&lt;/div&gt;</value>
  </data>
  <data xml:space="preserve" name="SystemUser.Text">
    <value>System</value>
  </data>
</root>]]></File>
  <File name="${ProjectName}.ascx.ru-RU.resx"><![CDATA[<?xml version="1.0" encoding="utf-8"?>
<root>
  <data xml:space="preserve" name="Template.Text">
    <value>&lt;div class="[CSSCLASS]"&gt;&lt;h3&gt;[CREATEDBYUSER]: [CREATEDONDATE]&lt;/h3&gt;&lt;p&gt;[CONTENT]&lt;/p&gt;&lt;/div&gt;</value>
  </data>
  <data xml:space="preserve" name="SystemUser.Text">
    <value>Система</value>
  </data>
</root>]]></File>
				</Directory>
                <Directory name="Properties">
<FileTemplateReference TemplateID="CSharpAssemblyInfo" name="AssemblyInfo.cs" />
				</Directory>
				<Directory name="components">
					<File name="${ProjectName}Controller.cs" AddStandardHeader="True"><![CDATA[using System;
using System.Collections.Generic;
using System.Text;
using System.Xml;
using System.Linq;
using DotNetNuke.Collections;
using DotNetNuke.Data;
using DotNetNuke.Common.Utilities;
using DotNetNuke.Entities.Modules;
using DotNetNuke.Services.Search;
using DotNetNuke.Services.Search.Entities;
using DotNetNuke.R7;

namespace ${ProjectName}
{
	public partial class ${ProjectName}Controller : ControllerBase
	{
		/// <summary>
		/// Initializes a new instance of the <see cref="${ProjectName}.${ProjectName}Controller"/> class.
		/// </summary>
		public ${ProjectName}Controller () : base ()
		{ 

		}

        #region ModuleSearchBase implementaion

        public override IList<SearchDocument> GetModifiedSearchDocuments (ModuleInfo modInfo, DateTime beginDate)
        {
            throw new NotImplementedException ();
        }

        #endregion
	}
}
]]></File>
<!--<FileTemplateReference TemplateID="DotNetNuke PetaPOCO class" name="${ProjectName}Info.cs" />-->
<File name="${ProjectName}Info.cs" AddStandardHeader="True"><![CDATA[using System;
using System.Linq;

using DotNetNuke.Data;
using DotNetNuke.ComponentModel.DataAnnotations;
using DotNetNuke.Entities.Portals;
using DotNetNuke.Entities.Users;

namespace ${ProjectName}
{
	// More attributes for class:
	// Set caching for table: [Cacheable("${ProjectName}_${Name}s", CacheItemPriority.Default, 20)] 
	// Explicit mapping declaration: [DeclareColumns]
	
	// More attributes for class properties:
	// Custom column name: [ColumnName("${ProjectName}ID")]
	// Explicit include column: [IncludeColumn]
	// Note: DAL 2 has no AutoJoin analogs from PetaPOCO at this time
	
	[TableName("${ProjectName}_${ProjectName}s")]
	[PrimaryKey("${ProjectName}ID", AutoIncrement = true)]
	[Scope("TabID")]
	public class ${ProjectName}Info
	{
        #region Fields
        
		private string createdByUserName = null;

		#endregion
		
		/// <summary>
		/// Empty default cstor
		/// </summary>
		public ${ProjectName}Info ()
		{
		}

        #region Properties

		public int ${ProjectName}ID { get; set; }

		public int TabID { get; set; }

		public string Content { get; set; }

		public int CreatedByUser { get; set; }

		[ReadOnlyColumn]
		public DateTime CreatedOnDate { get; set; }
        
		[IgnoreColumn]
		public string CreatedByUserName
		{
			get
			{
				if (createdByUserName == null)
				{
					var portalId = PortalController.Instance.GetCurrentPortalSettings ().PortalId;
					var user = UserController.GetUserById (portalId, CreatedByUser);
					createdByUserName = user.DisplayName;
				}

				return createdByUserName; 
			}
		    set 
		    {
		    	createdByUserName = value;
		    }
		}

        #endregion
	}
}
]]></File>

				</Directory>
				<File name="${ProjectName}.ascx"><![CDATA[<%@ Control Language="C#" AutoEventWireup="true" CodeBehind="${ProjectName}.ascx.cs" Inherits="${ProjectName}.${ProjectName}" %>
<%@ OutputCache Duration="1200" VaryByParam="TabId" %>

<asp:Literal ID="litContent" runat="server"></asp:Literal>
]]></File>
				<File name="${ProjectName}.ascx.cs" DependsOn="${ProjectName}.ascx" AddStandardHeader="True"><![CDATA[// TODO: Convert to DAL2

using System;
using System.IO;
using System.Web;

using System.Web.UI;
using System.Web.UI.WebControls;
using DotNetNuke.UI.Skins;
using DotNetNuke.Services.Localization;
using DotNetNuke.R7;

namespace ${ProjectName}
{
	public partial class ${ProjectName} : SkinObjectBase
	{
		private string localResourceFile = null;
		private string template = null;

		public string CssClass
		{
			get 
			{
				if (!string.IsNullOrEmpty(Attributes ["CssClass"]))
					return Attributes ["CssClass"];

				return string.Empty;		
			}
		}

		private string LocalResourceFile 
		{
			get 
			{ 
				if (localResourceFile == null)
					// NOTE: ASCX control name is needed!
					localResourceFile = Localization.GetResourceFile (this, "${ProjectName}.ascx");
				
				return localResourceFile; 
			}
		}
		
		private string Template 
		{
			get 
			{
				if (template == null) 
				{
					template = Localization.GetString ("Template.Text", LocalResourceFile);
					if (string.IsNullOrEmpty (template))
						template = "Error loading template from resource file!";
				}
				
				return this.template;
			}
		}			
				
		protected override void OnLoad (EventArgs e)
		{
			base.OnLoad(e);

			if (!IsPostBack)
			{
				var ctrl = new ${ProjectName}Controller ();
				var item = ctrl.Get<${ProjectName}Info>(PortalSettings.ActiveTab.TabID);

				if (item != null)
				{
					// stub for NULL values in usernames
					if (string.IsNullOrEmpty (item.CreatedByUserName))
						item .CreatedByUserName = Localization.GetString("SystemUser.Text", LocalResourceFile);
					
					// fill template
					var content = Template.Replace ("[CREATEDONDATE]", item.CreatedOnDate.ToShortDateString ());
					content = content.Replace ("[CREATEDBYUSER]", item.CreatedByUserName);
					content = content.Replace ("[CONTENT]", item.Content);
					content = content.Replace ("[CSSCLASS]", CssClass);

					litContent.Text = content;
				}
			}
		}
	}
}
]]></File>
				<File name="${ProjectName}.ascx.controls.cs" DependsOn="${ProjectName}.ascx" ShowAutogenerationNotice="False" AddStandardHeader="False" SuppressAutoOpen="True"><![CDATA[using System.Web;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Web.UI.HtmlControls;
using System.Linq;

using DotNetNuke.UI.UserControls;
using DotNetNuke.UI.WebControls;
using DotNetNuke.Web.UI.WebControls;

namespace ${ProjectName}
{
	public partial class ${ProjectName}
	{	
		protected Literal litContent;
	}
}]]></File>
  				<File name="${ProjectName}.dnn"><![CDATA[<dotnetnuke type="Package" version="5.0">
 <packages>
   <package name="${ProjectName}" type="SkinObject" version="00.01.00">
     <friendlyName>${ProjectName}</friendlyName>
     <description>This is a simple skin object to display a record from database table.</description>
     <owner>
       <name>${AuthorName}</name>
       <organization>${AuthorCompany}</organization>
       <url>http://www.${AuthorCompany}.com/${ProjectName}</url>
       <email>${AuthorEmail}</email>
     </owner>
	 <license src="license.htm" />
     <releaseNotes src="releaseNotes.htm" />
     <dependencies>
        <!-- <dependency type="CoreVersion">07.00.00</dependency> -->
        <dependency type="managedPackage" version="0.3.1">DotNetNuke.R7</dependency>
     </dependencies>
     <components>
        <component type="SkinObject">
  			<moduleControl>
			    <controlKey>${ProjectName}</controlKey>
    			<controlSrc>/DesktopModules/${ProjectName}/${ProjectName}/${ProjectName}.ascx</controlSrc>
    			<supportsPartialRendering>false</supportsPartialRendering>
  			</moduleControl>
		</component>

       <component type="Script">
         <scripts>
           <basePath>DesktopModules\${ProjectName}\${ProjectName}</basePath>
           <script type="Install">
             <name>SqlDataProvider\00.01.00.SqlDataProvider</name>
             <version>00.01.00</version>
           </script>
           <script type="UnInstall">
             <name>SqlDataProvider\Uninstall.SqlDataProvider</name>
             <version>00.01.00</version>
           </script>
         </scripts>
       </component>

       <component type="ResourceFile">
         <resourceFiles>
           <basePath>DesktopModules\${ProjectName}</basePath>
           <resourceFile>
             <name>Resources.zip</name>
           </resourceFile>
         </resourceFiles>
       </component>

       <component type="Assembly">
         <assemblies>
           <basePath>bin</basePath>
           <assembly>
             <path>bin</path>
             <name>${ProjectName}.dll</name>
           </assembly>
         </assemblies>
       </component>
    
     </components>
   </package>
 </packages>
</dotnetnuke>
]]></File>
<File name="SETUP.md"><![CDATA[# Template usage

Due to template engine limitations we need to do some will require some changes 
to be made manually.

1. You may want to disable automatic updates of CodeBehind partial classes in project options
   under "ASP.NET" page. Automatic updates is not working correctly with third-party controls 
   in the MonoDevelop / Xamarin Studio anyway. This is true at least for version 4.2.3.

2. Add to your solution new project of type "DNN packaging project" and follow instructions 
   in it's `SETUP.md` to setup packaging and local deploy.

# Solution stucture for development

```
DNN
|- bin
    |- ${SolutionName}.dll
    |- ${SolutionName}_Next.dll
|- DesktopModules
    |- ${SolutionName} (solution)
        |- ${SolutionName} (primary extension project)
            |- SqlDataProvider (folder for DB scripts)
                |- 00.01.00.SqlDataProvider
                |- UnInstall.SqlDataProvider
            |- ${SolutionName}.dnn (manifest)
            |- license.htm
            |- releaseNotes.htm
        |- ${SolutionName}_Next (secondary extension project)
            |- ...
        |- Packaging (packaging project)
            |- *.targets
```
]]></File>
   <File name="license.htm"><![CDATA[<p>This module is published under the terms of MIT/X11 License.</p>
]]></File>
   <File name="releaseNotes.htm"><![CDATA[<!-- 
<h3>Version 0.2.0</h3>
<p>General version notes.</p>
<ul>
	<li>Added new feature.</li>
	<li>Fixed bug.</li>
</ul>
-->

<h3>Version 0.1.0</h3>
<p>This is the initial release.</p>
]]></File>
			</Files>
		</Project>
	</Combine>
</Template>