<?xml version="1.0"?>
<Template Originator="Roman M. Yagodin" Created="2014/06/18" LastModified="2015/02/10">
	<!-- Template Header -->
	<TemplateConfiguration>
		<_Name>Install DNN package script</_Name>
		<_Category>DNN Platform</_Category>
		<Icon>md-xml-file-icon</Icon>
		<LanguageName>*</LanguageName>
		<_Description>Creates a new MSBuild install package script for DNN extension.</_Description>
	</TemplateConfiguration>
	<!-- Template Content -->
	<TemplateFiles>
		<File name="${Name}.targets" AddStandardHeader="False"><![CDATA[<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" ToolsVersion="4.0" DefaultTargets="MakeInstallPackage">
    <Target Name="MakeInstallPackage" Condition=" '$(Configuration)|$(Platform)' == 'Release|AnyCPU' ">
        <!-- Read package version from the manifest -->
        <XmlRead Prefix="n" Namespace="http://schemas.microsoft.com/developer/msbuild/2003" XPath="/dotnetnuke/packages/package[1]/@version" XmlFileName="..\${SolutionName}\${SolutionName}.dnn">
            <Output TaskParameter="Value" PropertyName="Version" />
        </XmlRead>
        
        <!-- Declare binaries -->
        <ItemGroup> 
            <InstallBinaryFiles Include="$(MainProjectOutputPath)\${SolutionName}*.dll" />
        </ItemGroup>

        <!-- Declare manifest files -->
        <ItemGroup>
            <InstallManifestFiles Include="..\${SolutionName}\*.dnn" />
            <InstallManifestFiles Include="..\${SolutionName}\*.dnn6" />
            <InstallManifestFiles Include="..\${SolutionName}\license.htm" />
            <InstallManifestFiles Include="..\${SolutionName}\releaseNotes.htm" />
        </ItemGroup>

        <!-- Declare SqlDataProvider files -->
        <ItemGroup>
            <InstallSqlDataProviderFiles Include="..\${SolutionName}\SqlDataProvider\*.SqlDataProvider" />
        </ItemGroup>

         <!-- Declare resource files -->
        <ItemGroup>
            <InstallResourceFiles Include="..\**\*.ascx" />
            <InstallResourceFiles Include="..\**\*.aspx" />
            <InstallResourceFiles Include="..\**\*.asmx" />
            <InstallResourceFiles Include="..\**\*.ashx" />
            <InstallResourceFiles Include="..\**\*.resx" />
            <InstallResourceFiles Include="..\**\*.css" />
            <InstallResourceFiles Include="..\**\*.html" />
            <InstallResourceFiles Include="..\**\*.htm" Exclude="..\${SolutionName}\license.htm;..\${SolutionName}\releaseNotes.htm" />
            <InstallResourceFiles Include="..\**\*.xml" />
            <InstallResourceFiles Include="..\**\*.xsl" />
            <InstallResourceFiles Include="..\**\*.xslt" />
            <InstallResourceFiles Include="..\**\*.resx" />
            <InstallResourceFiles Include="..\**\*.js" />
            <InstallResourceFiles Include="..\**\*.jpg" />
            <InstallResourceFiles Include="..\**\*.png" />
            <InstallResourceFiles Include="..\**\*.gif" />
        </ItemGroup>

        <!-- Declare excluded files -->
        <ItemGroup>
            <InstallExcludeFiles Include="..\packages\**\*" />
            <InstallExcludeFiles Include="..\${ProjectName}\**\*" />
            <InstallExcludeFiles Include="..\.git\**\*" />
            <InstallExcludeFiles Include="..\.svn\**\*" />
            <InstallExcludeFiles Include="..\*\bin\**\*" />
            <InstallExcludeFiles Include="..\*\obj\**\*" />
            <InstallExcludeFiles Include="..\*\_ReSharper*\**\*" />
        </ItemGroup>

        <!-- Apply excluded files filters -->
        <ItemGroup>
            <InstallResourceFilteredFiles Include="@(InstallResourceFiles)" Exclude="@(InstallExcludeFiles)" />
        </ItemGroup>
       
        <!-- Copy binaries -->
        <Copy SourceFiles="@(InstallBinaryFiles)" DestinationFolder="$(MSBuildProjectDirectory)\tmp\Package\bin" />
        
        <!-- Copy manifest files -->
        <Copy SourceFiles="@(InstallManifestFiles)" DestinationFolder="$(MSBuildProjectDirectory)\tmp\Package" />
        
        <!-- Copy SqlDataProvider files -->
        <Copy SourceFiles="@(InstallSqlDataProviderFiles)" DestinationFolder="$(MSBuildProjectDirectory)\tmp\Package\SqlDataProvider" />
        
        <!-- Copy filtered Resource files to tmp\Resources dir -->
        <Copy SourceFiles="@(InstallResourceFilteredFiles)" DestinationFolder="$(MSBuildProjectDirectory)\tmp\Resources\%(RecursiveDir)" />
       
        <!-- Declare files to zip -->
        <ItemGroup>
            <InstallResourceZipFiles Include="$(MSBuildProjectDirectory)\tmp\Resources\**\*.*" />
        </ItemGroup>

        <!-- Create Resources.zip -->
        <Zip Files="@(InstallResourceZipFiles)" WorkingDirectory="$(MSBuildProjectDirectory)\tmp\Resources" ZipFileName="Resources.$(PackageExtension)" />

        <!-- Move Resources.zip to tmp\Package dir -->
        <Copy SourceFiles="$(MSBuildProjectDirectory)\Resources.$(PackageExtension)" DestinationFolder="$(MSBuildProjectDirectory)\tmp\Package/" />
        <Delete Files="$(MSBuildProjectDirectory)\Resources.$(PackageExtension)" />

        <!-- Declare install package files -->
        <ItemGroup>
            <InstallPackageFiles Include="$(MSBuildProjectDirectory)\tmp\Package\**\*.*" />
        </ItemGroup>

        <!-- Create the install package -->
        <Zip Files="@(InstallPackageFiles)" WorkingDirectory="$(MSBuildProjectDirectory)\tmp\Package" ZipFileName="$(PackageName)-$(Version)-Install.$(PackageExtension)" />
        
        <!-- Copy the install package to the output directory -->
        <Copy SourceFiles="$(MSBuildProjectDirectory)\$(PackageName)-$(Version)-Install.$(PackageExtension)" DestinationFolder="$(PackageOutputPath)/" />
        <Delete Files="$(MSBuildProjectDirectory)\$(PackageName)-$(Version)-Install.$(PackageExtension)" />

        <!-- Cleanup -->
        <RemoveDir Directories="$(MSBuildProjectDirectory)\tmp\Resources" />
        <RemoveDir Directories="$(MSBuildProjectDirectory)\tmp\Package" />
        <RemoveDir Directories="$(MSBuildProjectDirectory)\tmp" />
    </Target>
</Project>
]]></File>
	</TemplateFiles>
</Template>
